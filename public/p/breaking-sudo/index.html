<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Breaking sudo | ~/adi</title>
    <meta name="description" content="A while back I wrote about using TouchID to authenticate sudo. I made this change when I was still using Terminal.app and everything worked fine.
As we all know, 2020 has been a year full of unexpected changes, the most notable of which is clearly me switching to iTerm2 as my terminal emulator. This broke the TouchID setup I had done earlier and I was back to typing out my password.
">
    <link rel="canonical" href="https://adstastic.github.io/p/breaking-sudo/">
    <link rel="alternate" type="application/rss+xml" title="~/adi" href="https://adstastic.github.io/feed.xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&family=Ubuntu+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <script>
        
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
</head>
<body>
    <div class="page-content">
        
<section class="site-header">
    <h1 class="smallcap"><a class="site-title" href="https://adstastic.github.io/">~/adi</a></h1>
</section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Breaking sudo</h1>
        <p class="post-meta">
            <time datetime="2020-11-06T00:00:00Z" itemprop="datePublished">Nov 06, 2020</time>
            
            
            &middot; <span class="tags" itemprop="tags">
                
                <a href="/tags/programming/">#programming</a>
                
                <a href="/tags/macos/">#macOS</a>
                
            </span>
            
        </p>
    </header>
    <div class="post-content" itemprop="articleBody">
        <p>A while back I wrote about using <a href="/sudo-touchid">TouchID to authenticate sudo</a>. I made this change when I was still using Terminal.app and everything worked fine.</p>
<p>As we all know, 2020 has been a year full of unexpected changes, the most notable of which is clearly me switching to iTerm2 as my terminal emulator. This broke the TouchID setup I had done earlier and I was back to typing out my password.</p>
<p>Today I learned why: iTerm2 by default allows sessions to survive logging out and back in again and this breaks<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> the TouchID authentiation for sudo.</p>
<p>Turning this off from <strong>Preferences &gt; Advanced &gt; Allow sessions to survive logging out and back in again</strong> will reinstate your ability to give your Macbook the finger to get it to do stuff you probably shouldn&rsquo;t<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> be doing.</p>
<p>However, once this feature was gone I realised I missed it and it&rsquo;s absence was a black hole<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> in the fabric of my developer experience so I found a <a href="https://github.com/fabianishere/pam_reattach">workaround</a>. After following the installation and usage instructions, I was ready to use my finger for sudo as well as have my terminal sessions survive logouts.</p>
<p>Here&rsquo;s what happened next:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo ls
</span></span><span class="line"><span class="cl">sudo: unable to initialize PAM: No such file or directory
</span></span></code></pre></div><p>The magnitude of what had happened dawned on me. I had broken sudo, and I couldn&rsquo;t fix it because I needed sudo to edit the file to undo what I had just done.</p>
<p>A quick Google suggested rebooting into Single-User mode (power-on then ⌘-S) to get root access to the machine. This didn&rsquo;t work, which made a lot of sense because that T2 chip ain&rsquo;t very useful if someone needs just to reboot holding down 2 keys to get a root shell.</p>
<p>I kept searching, slowing accepting that I would need to reinstall the OS. Just as I was about to give up, I found a way to get a root shell via Recovery mode and it worked!</p>
<ol>
<li>Boot to Recovery mode (power-on then ⌘-R)</li>
<li>Open Disk Utility - there should be 2 unmounted volumes e.g. <em>Macintosh HD</em> and <em>Macintosh HD - Data</em>. They may be named differently but one will have a &ldquo;- Data&rdquo; suffix.</li>
<li>Mount <em>Macintosh HD</em></li>
<li>Quit Disk Utility</li>
<li>Open the Terminal - it&rsquo;s under Utilities in the menu bar</li>
<li><code>cd /Volumes/&quot;Macintosh HD</code></li>
<li><code>vi /etc/pam.d/sudo</code></li>
<li>Remove the offending line</li>
<li><code>!wq</code></li>
<li>Restart</li>
</ol>
<p>So how does this bypass the T2 security chip? It doesn&rsquo;t, my password was required to enter recovery mode as well as to mount the drive.</p>
<p>That was enough fun for a lifetime&hellip;I think I&rsquo;ll be okay without my sessions surviving logouts<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>.</p>
<p>Footnotes:</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://gitlab.com/gnachman/iterm2/-/issues/7608#note_153123852">https://gitlab.com/gnachman/iterm2/-/issues/7608#note_153123852</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Unless you know what you are doing - then of course you should be doing it.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>It really wasn&rsquo;t a big deal I just wanted both features to work.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>I&rsquo;ll just never logout.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    </div>
    
    
    
    
    
    
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
        
        
            
            
                
            
                
            
            
        
    
    
    
    
    
    
    
    <hr>
</article>

    </div>
    
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('dark-mode-toggle');
            const body = document.body;
            const html = document.documentElement;
            
            
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                html.classList.add('dark-theme');
                toggle.checked = true;
            } else {
                body.removeAttribute('data-theme');
                html.classList.remove('dark-theme');
                toggle.checked = false;
            }
            
            
            toggle.addEventListener('change', function() {
                if (this.checked) {
                    body.setAttribute('data-theme', 'dark');
                    html.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.removeAttribute('data-theme');
                    html.classList.remove('dark-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
        });
    </script>
</body>
</html>